#!/bin/bash
set -e

# CCUsage Monitor - One-command installer with auto-start
echo "🚀 Installing CCUsage Monitor..."

# Check system requirements
if ! command -v swift &> /dev/null; then
    echo "❌ Swift not found. Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "Please run this installer again after Xcode tools finish installing."
    exit 1
fi

if ! command -v npm &> /dev/null; then
    echo "❌ Node.js/npm not found. Please install from https://nodejs.org"
    exit 1
fi

# Install ccusage if not present
if ! command -v ccusage &> /dev/null; then
    echo "📦 Installing ccusage CLI dependency..."
    npm install -g ccusage
fi

# Test ccusage works
echo "🔍 Testing ccusage connection..."
if ! npx ccusage blocks --active --json &> /dev/null; then
    echo "⚠️  CCUsage test failed. Please ensure you have Claude API access configured."
    echo "   Visit: https://github.com/evanmschultz/ccusage for setup instructions"
fi

# Install CCUsage Monitor
INSTALL_DIR="$HOME/.local/share/ccusage-monitor"
mkdir -p "$INSTALL_DIR"
mkdir -p "$HOME/.local/bin"
cp bin/main.swift "$INSTALL_DIR/"

# Create launcher script
cat > "$HOME/.local/bin/ccusage-monitor" << 'EOF'
#!/bin/bash
cd "$HOME/.local/share/ccusage-monitor"
nohup swift main.swift > /dev/null 2>&1 &
echo "CCUsage Monitor started in menu bar"
EOF

chmod +x "$HOME/.local/bin/ccusage-monitor"

# Setup auto-start (default behavior)
echo "⚙️  Setting up automatic startup..."
PLIST_PATH="$HOME/Library/LaunchAgents/com.ccusage.monitor.plist"
mkdir -p "$HOME/Library/LaunchAgents"

cat > "$PLIST_PATH" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.ccusage.monitor</string>
    <key>ProgramArguments</key>
    <array>
        <string>$HOME/.local/bin/ccusage-monitor</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
    <key>StandardOutPath</key>
    <string>/dev/null</string>
    <key>StandardErrorPath</key>
    <string>/dev/null</string>
</dict>
</plist>
EOF

# Load the launch agent
launchctl unload "$PLIST_PATH" 2>/dev/null || true
launchctl load "$PLIST_PATH"

# Start immediately
"$HOME/.local/bin/ccusage-monitor"

echo ""
echo "✅ CCUsage Monitor installed successfully!"
echo "✅ Auto-start enabled - will launch at login"
echo "✅ Monitor running in menu bar now"
echo ""
echo "Commands:"
echo "  Start:    ccusage-monitor"
echo "  Stop:     pkill -f 'swift main.swift'"
echo "  Disable:  launchctl unload ~/Library/LaunchAgents/com.ccusage.monitor.plist"